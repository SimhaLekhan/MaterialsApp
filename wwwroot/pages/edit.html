<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Edit Material</title>
  <link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/12.0.0/default/default-main.css">
  <style>
    body { font-family: system-ui, Segoe UI, Roboto, Arial; margin: 24px; }
    form { max-width: 820px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px; }
    label { font-weight: 600; display:block; margin-bottom: 6px; }
    .actions { margin-top: 12px; }
  </style>
</head>
<body>
  <h2>Edit Material</h2>
  <p><a href="/index.html">&larr; Home</a> • <a href="/pages/list.html">View List</a></p>

  <span id="notify"></span>

  <form id="materialForm">
    <div class="row">
      <div>
        <label for="Name">Name *</label>
        <input id="Name" name="Name" required />
      </div>
      <div>
        <label for="Category">Category *</label>
        <input id="Category" name="Category" required />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="Brand">Brand</label>
        <input id="Brand" name="Brand" />
      </div>
      <div>
        <label for="UnitPrice">Unit Price *</label>
        <input id="UnitPrice" name="UnitPrice" required />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Unit of Measure</label>
        <div id="UnitOfMeasure"></div>
      </div>
      <div>
        <label for="GstPercent">GST % (0–28)</label>
        <input id="GstPercent" name="GstPercent" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="InStockQty">In-Stock Qty</label>
        <input id="InStockQty" name="InStockQty" />
      </div>
      <div>
        <label for="ReorderLevel">Reorder Level</label>
        <input id="ReorderLevel" name="ReorderLevel" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="IsActive">Active?</label>
        <input id="IsActive" type="checkbox" />
      </div>
      <div>
        <label for="AddedOn">Added On</label>
        <input id="AddedOn" name="AddedOn" />
      </div>
    </div>

    <div class="actions">
      <button id="btnUpdate">Update</button>
      <button id="btnCancel" type="button">Cancel</button>
    </div>
  </form>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://kendo.cdn.telerik.com/2025.3.825/js/kendo.all.min.js"></script>
  <script>
    const id = new URLSearchParams(location.search).get("id");
    if (!id) {
      alert("Invalid id");
      location.href = "/pages/list.html";
    }

    // Notification
    const notify = $("#notify").kendoNotification({
      position: { pinned: true, top: 20, right: 20 }
    }).data("kendoNotification");

    // Kendo widgets
    $("#Name").kendoTextBox();
    $("#Brand").kendoTextBox();

    $("#Category").kendoDropDownList({
      optionLabel: "Select category...",
      dataSource: ["Cement", "Steel", "Sand", "Bricks", "Aggregates", "Tiles"]
    });

    $("#UnitPrice").kendoNumericTextBox({ format: "c2", min: 0.01, step: 1 });
    $("#GstPercent").kendoNumericTextBox({ format: "n2", min: 0, max: 28, step: 0.5 });
    $("#InStockQty").kendoNumericTextBox({ format: "n0", min: 0, step: 1 });
    $("#ReorderLevel").kendoNumericTextBox({ format: "n0", min: 0, step: 1 });

    $("#UnitOfMeasure").kendoRadioGroup({
      items: [
        { label: "Bag", value: "Bag" },
        { label: "Kg",  value: "Kg"  },
        { label: "Ton", value: "Ton" }
      ],
      layout: "horizontal"
    });

    $("#IsActive").kendoSwitch();
    $("#AddedOn").kendoDatePicker();

    // Validator
    const validator = $("#materialForm").kendoValidator({
      rules: {
        positivePrice: function(input) {
          if (input.attr("name") === "UnitPrice") {
            const val = $("#UnitPrice").data("kendoNumericTextBox").value();
            return val !== null && val > 0;
          }
          return true;
        },
        gstRange: function(input) {
          if (input.attr("name") === "GstPercent") {
            const val = $("#GstPercent").data("kendoNumericTextBox").value();
            return val === null || (val >= 0 && val <= 28);
          }
          return true;
        }
      },
      messages: {
        required: "This field is required",
        positivePrice: "Unit Price must be > 0",
        gstRange: "GST must be between 0 and 28"
      }
    }).data("kendoValidator");

    // Load existing material data
    $.getJSON("/api/materials/" + id)
      .done(function(data) {
        $("#Name").val(data.name);
        $("#Category").data("kendoDropDownList").value(data.category);
        $("#Brand").val(data.brand || "");
        $("#UnitPrice").data("kendoNumericTextBox").value(data.unitPrice);
        $("#UnitOfMeasure").data("kendoRadioGroup").value(data.unitOfMeasure);
        $("#InStockQty").data("kendoNumericTextBox").value(data.inStockQty);
        $("#ReorderLevel").data("kendoNumericTextBox").value(data.reorderLevel);
        $("#GstPercent").data("kendoNumericTextBox").value(data.gstPercent);
        $("#IsActive").data("kendoSwitch").check(data.isActive);
        $("#AddedOn").data("kendoDatePicker").value(kendo.parseDate(data.addedOn));
      })
      .fail(() => {
        notify.show("Material not found", "error");
        setTimeout(() => location.href = "/pages/list.html", 800);
      });

    // Update via AJAX
    $("#btnUpdate").kendoButton().on("click", function(e) {
      e.preventDefault();
      if (!validator.validate()) {
        notify.show("Please fix validation errors.", "error");
        return;
      }

      const dto = {
        materialId: parseInt(id),
        name: $("#Name").val(),
        category: $("#Category").data("kendoDropDownList").value(),
        brand: $("#Brand").val(),
        unitPrice: $("#UnitPrice").data("kendoNumericTextBox").value(),
        unitOfMeasure: $("#UnitOfMeasure").data("kendoRadioGroup").value(),
        inStockQty: $("#InStockQty").data("kendoNumericTextBox").value() || 0,
        reorderLevel: $("#ReorderLevel").data("kendoNumericTextBox").value() || 0,
        gstPercent: $("#GstPercent").data("kendoNumericTextBox").value() || 0,
        isActive: $("#IsActive").data("kendoSwitch").check(),
        addedOn: $("#AddedOn").data("kendoDatePicker").value()
      };

      $.ajax({
        url: "/api/materials/" + id,
        method: "PUT",
        contentType: "application/json",
        data: JSON.stringify(dto)
      })
      .done(() => {
        notify.show("Updated successfully!", "success");
        setTimeout(() => window.location.href = "/pages/details.html?id=" + id, 600);
      })
      .fail((xhr) => {
        const msg = xhr.responseJSON?.title || xhr.responseText || "Update failed";
        notify.show(msg, "error");
      });
    });

    // Cancel
    $("#btnCancel").kendoButton().on("click", function() {
      window.location.href = "/pages/details.html?id=" + id;
    });
  </script>
</body>
</html>
